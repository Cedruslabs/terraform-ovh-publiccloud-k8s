{
  "min_packer_version": "0.12.0",
  "variables": {
    "module_cfssl_version": "v0.1.2",
    "module_etcd_version": "v0.1.0",
    "ssh_username": "core",
    "source_image_name": "CoreOS Stable",
    "identity_endpoint": "{{env `OS_AUTH_URL`}}",
    "region": "{{env `OS_REGION_NAME`}}",
    "ext_net_id": "",
    "cfssl_version": "R1.2",
    "cfssl_sha256sum": "eb34ab2179e0b67c29fd55f52422a94fe751527b06a403a79325fed7cf0145bd",
    "cfssl_install_dir": "install-cfssl-0.1.1/terraform-ovh-publiccloud-cfssl-0.1.1/modules/install-cfssl",
    "etcd_version": "3.3.0",
    "etcd_sha256sum": "d91efb17ab0813039e24863a1af154b153d4b1a009181d6faa18e8ab681676dc",
    "etcd_install_dir": "install-etcd-0.1.1/terraform-ovh-publiccloud-cfssl-0.1.1/modules/install-cfssl"
  },
  "builders": [
    {
      "type": "openstack",
      "flavor": "s1-2",
      "image_name": "{{user `source_image_name`}} K8s",
      "source_image_name": "{{user `source_image_name`}}",
      "identity_endpoint": "{{user `identity_endpoint`}}",
      "region": "{{user `region`}}",
      "ssh_username": "{{user `ssh_username`}}",
      "ssh_ip_version": "4",
      "networks": ["{{user `ext_net_id`}}"]
    }
  ],
  "provisioners": [
    {
      "type": "shell-local",
      "command": "rm -rf {{template_dir}}/tmp-module; mkdir {{template_dir}}/tmp-module"
    },
    {
      "type": "shell-local",
      "command": "git clone --branch {{user `module_cfssl_version`}} https://github.com/ovh/terraform-ovh-publiccloud-cfssl.git {{template_dir}}/tmp-module/terraform-ovh-cfssl"
    },
    {
      "type": "shell-local",
      "command": "git clone --branch {{user `module_etcd_version`}} https://github.com/ovh/terraform-ovh-publiccloud-etcd.git {{template_dir}}/tmp-module/terraform-ovh-etcd"
    },
    {
      "type": "file",
      "source": "{{template_dir}}/../../modules",
      "destination": "/tmp/current-module"
    },
    {
      "type": "file",
      "source": "{{template_dir}}",
      "destination": "/tmp/tmp-modules"
    },
    {
      "type": "shell-local",
      "command": "rm -rf {{template_dir}}/tmp-module"
    },
    {
      "type": "shell",
      "inline": [
        "/tmp/tmp-modules/tmp-module/terraform-ovh-cfssl/modules/install-cfssl/install-cfssl --version {{user `cfssl_version`}} --sha256sum {{user `cfssl_sha256sum`}}",
        "/tmp/tmp-modules/tmp-module/terraform-ovh-etcd/modules/install-etcd/install-etcd --version {{user `etcd_version`}} --sha256sum {{user `etcd_sha256sum`}}"
      ]
    },
    {
      "type": "file",
      "source": "../../modules/install-k8s/install/scripts/install_python.sh",
      "destination": "/tmp/"
    },
    {
      "type": "file",
      "source": "../../modules/install-k8s/install/scripts/install_ansible.sh",
      "destination": "/tmp/"
    },
    {
      "type": "shell",
      "inline": [
        "sudo bash /tmp/install_python.sh",
        "sudo bash /tmp/install_ansible.sh"
      ]
    },
    {
      "type": "file",
      "source": "vars.yaml",
      "destination": "/tmp/vars.yaml"
    },
    {
      "type": "ansible-local",
      "playbook_file": "../../modules/install-k8s/install/site.yaml",
      "role_paths": [
        "../../modules/install-k8s/install/roles/common",
        "../../modules/install-k8s/install/roles/kubernetes"
      ],
      "command": "ANSIBLE_FORCE_COLOR=1 PYTHONUNBUFFERED=1 /opt/python/bin/ansible-playbook",
      "extra_arguments": ["-vvv --extra-vars ansible_python_interpreter=/opt/python/bin/python2.7 --extra-vars @/tmp/vars.yaml"]
    },
    {
      "type": "shell",
      "inline": [
        "sudo rm -rf /opt/python"
      ]
    }
  ]
}
