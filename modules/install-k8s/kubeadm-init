#!/bin/bash -e

# Prepare etcdctl command
export ETCDCTL_API=3
ETCDCTL_COMMAND="/opt/etcd/bin/etcdctl --cacert /opt/etcd/certs/ca.pem --cert /opt/etcd/certs/cert.pem --key /opt/etcd/certs/cert-key.pem --endpoints https://localhost:2379 "

# Expose k8s tools path for kubeadm
PATH=$PATH:/opt/k8s/bin

# Try to get PKI from etcd, if already generated by a previous run of kubeadm
pki=$($ETCDCTL_COMMAND get --print-value-only k8s-pki)
if [[ -z "$pki" ]];
then
  echo "First master, generating PKI"
  /opt/k8s/bin/kubeadm init --config=/etc/kubernetes/kubeadm/config.yaml
  if [[ "$?" -ne "0" ]]
  then
    echo "Failed to initialize with kubeadm..."
    exit 1
  fi

  (cd /etc/kubernetes && $ETCDCTL_COMMAND put k8s-pki "$(tar -cf - ./pki | base64)")
else
  echo "PKI already in etcd"
  (cd /etc/kubernetes && echo -e "$pki" | base64 -d | tar -xf -)
  /opt/k8s/bin/kubeadm init --config=/etc/kubernetes/kubeadm/config.yaml
fi
